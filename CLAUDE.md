# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Code Quality Guidelines

### Diagnostic Warnings
- **ALWAYS** check for and fix diagnostic warnings (TypeScript, ESLint, etc.) when making edits
- Use the VS Code diagnostics MCP tool to check for warnings before considering work complete
- Common warnings to watch for:
  - Unused imports and variables
  - ESLint style violations (unnecessary braces, etc.)
  - TypeScript type errors
  - Missing or incorrect type annotations

## Common Commands

### Build Commands
- `npm run compile` - Compile TypeScript code and run type checking
- `npm run watch` - Watch mode for continuous compilation during development
- `npm run package` - Build for production (runs type check and esbuild)
- `node esbuild.js` - Direct esbuild compilation without type checking
- `node esbuild.js --watch` - Watch mode for esbuild

### Type Checking and Linting
- `npm run check-types` - Run TypeScript type checking only
- No explicit lint command defined - ESLint is configured but must be run manually

### Testing
- No test runner configured - tests are present but no npm script to run them

### Publishing
- `vsce package` - Create VSIX package for distribution
- `vsce publish` - Publish to VS Code marketplace

## Architecture Overview

This is a VS Code extension for Malterlib C++ syntax highlighting and semantic coloring. The key components:

### Extension Structure
- **src/extension.ts** - Main extension entry point that:
  - Registers semantic token providers for C/C++ files
  - Loads classification data from JSON files (scopes.json, keywords.json, etc.)
  - Implements identifier classification logic based on Malterlib naming conventions
  - Handles configuration changes for enabling/disabling semantic coloring

### Data Files
- **scopes.json** - Combined file containing keywords, prefixes, and semantic scopes
- **themes/** - Contains Malterlib color themes (Display P3 and sRGB variants)
- **syntaxes/** - TextMate grammar for Malterlib build files (.MTarget, .MBuildSystem, etc.)
- **scripts/** - Python utilities for theme generation, scope processing, and clangd config

### Key Features
1. **Semantic Token Provider** - Custom identifier classification based on Malterlib naming conventions:
   - Prefix-based classification (e.g., `m_` for members, `f_` for functions)
   - Special handling for variable prefixes with concept chars (binpfro)
   - Keyword recognition for C++ and Malterlib-specific terms

2. **Theme Support** - Two color themes optimized for different color spaces:
   - Malterlib (Display P3)
   - Malterlib (sRGB)

3. **Build File Support** - Syntax highlighting for Malterlib build system files

### Configuration
- `malterlib.enableSemanticColoring` - Toggle semantic token coloring (default: false)
- Designed to work alongside clangd for full language support

### Extension Activation
- Activates on C/C++ files and Malterlib build files
- Waits for clangd extension before registering providers
- Re-registers providers when configuration changes

## Generated Files

Many files in this repository are generated from source data. Run `python3 scripts/update_all.py` to regenerate all of them:

### Generated from Highlighterr C++ Source
1. **prefixmap.json** - Generated by `parse_prefix_map.py` from `../Highlighterr/HighlighterrCxx/HighlighterrCxx.cpp`
   - Extracts prefix mapping rules from ms_PrefixMap entries
   - Contains prefix → classification + variable flag mappings

2. **classifications.json** - Generated by `generate_classifications.py` from `../Highlighterr/HighlighterrCxx/HighlighterrCxx.h`
   - Maps EClassification enum values to TextMate scopes
   - Source of truth for all classification → scope mappings

3. **keywords.json** - Generated by `extract_keywords.py` from `../Highlighterr/HighlighterrCxx/HighlighterrCxx.cpp`
   - Extracts keywords from f_AddDefaultKeyword_* function calls
   - Excludes JavaScript-specific keywords and example keywords

### Combined Data Files
4. **scopes.json** - Generated by `combine_scopes.py` from above JSON files
   - Combines keywords, prefixes, and classifications into single file
   - Used directly by extension.ts for identifier classification
   - Contains all unique scopes used in the extension

### Theme and Settings Files
5. **settings.json** - Generated by `generate_settings_from_theme.py` from `themes/malterlib.json`
   - Display P3 color settings for manual VS Code configuration
   - Extracts tokenColors rules from theme file

6. **settingsSRGB.json** - Generated by `generate_settings_from_theme.py` from `themes/malterlib.json`
   - sRGB-converted version of settings.json
   - For displays/VS Code builds without wide-gamut support

7. **themes/malterlibSRGB.json** - Generated by `convert_theme_to_srgb.py` from `themes/malterlib.json`
   - Complete sRGB-converted theme file
   - Uses ICC perceptual color mapping for conversion

### Configuration Files
8. **.clangd** - Generated by `generate_clangd_config.py` from `scopes.json`
   - SemanticTokens configuration for clangd
   - Replicates extension.ts classification logic in YAML rules
   - Uses template from `.clangd-template` if available

9. **semanticScopesForPackage.json** - Generated by `generate_clangd_config.py` from `scopes.json`
   - Maps clangd custom modifiers to TextMate scopes
   - Required for clangd semantic token integration

10. **README.md** - Generated by `generate_readme.py` from `README-template.md`
    - Inserts recommended settings from generated JSON files
    - Includes clangd configuration snippet

### Source of Truth
- **Highlighterr C++ codebase** - Classification logic and naming conventions
- **themes/malterlib.json** - Master color theme (Display P3)
- **README-template.md** - Documentation template
- **.clangd-template** - Optional template for clangd config structure